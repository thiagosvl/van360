name: OTA Deploy

on:
  push:
    branches: ["main"]

jobs:
  build-and-upload:
    runs-on: ubuntu-latest

    env:
      VERSION: v${{ github.run_id }}

    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Instalar dependências
        run: npm install

      - name: Build do app
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
        run: npm run build

      - name: Compactar bundle
        run: |
          mkdir -p dist_zip
          cd dist && zip -r ../dist_zip/app-${VERSION}.zip .

      - name: Enviar para Supabase Storage
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          curl -X POST "$SUPABASE_URL/storage/v1/object/ota/app-${VERSION}.zip" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Content-Type: application/zip" \
            --data-binary @dist_zip/app-${VERSION}.zip

      - name: Registrar nova versão no banco
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          PUBLIC_URL="$SUPABASE_URL/storage/v1/object/public/ota/app-${VERSION}.zip"
          curl -X POST "$SUPABASE_URL/rest/v1/app_updates" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "platform": "android",
              "latest_version": "'${VERSION}'",
              "url_zip": "'${PUBLIC_URL}'"
            }'

      - name: Limpar versões antigas (manter apenas as 3 mais recentes)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "[INFO] Limpando versões antigas..."
          FILES=$(curl -s "$SUPABASE_URL/storage/v1/object/list/ota?limit=1000" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" | jq -r '.[].name' | sort -r)
          COUNT=0
          for FILE in $FILES; do
            COUNT=$((COUNT+1))
            if [ $COUNT -gt 3 ]; then
              echo "Deletando versão antiga: $FILE"
              curl -s -X DELETE "$SUPABASE_URL/storage/v1/object/ota/$FILE" \
                -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
                -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" > /dev/null
            fi
          done
          echo "[INFO] Limpeza concluída."
